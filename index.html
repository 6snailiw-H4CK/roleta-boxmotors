<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Box Motors - Roleta de Pr√™mios</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    /* --------------------
       ESTILOS PRINCIPAIS
    -------------------- */
    body {
      background-color: #c4c4c477;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      overflow-x: hidden;
    }
    #logo { width: 480px; margin-bottom: 20px; transition: all 0.3s; }
    input, button {
      padding: 10px; margin: 5px;
      border: none; border-radius: 5px;
      font-size: 16px;
    }
    input { 
      width: 220px; 
      box-sizing: border-box;
      width: 100%; 
      max-width: 220px; 
    }
    button { background-color: white; color: black; cursor: pointer; }
    button:disabled { cursor: not-allowed; opacity: 0.6; }
    #roleta-container { position: relative; width: 300px; height: 300px; margin: 20px auto; transition: all 0.3s; }
    #seta-indicadora { font-size: 50px; color: limegreen; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); position: absolute; top:50%; right:-30px; transform: translateY(-50%); z-index:10; transition: all 0.3s; }
    canvas { border-radius: 50%; width: 100%; height: 100%; }
    #spin { background-color: red; color: white; font-weight: bold; font-size: 18px; margin: 20px auto; display: block; }
    #result { margin-top: 20px; font-size: 20px; color: rgb(10,84,0); }
    #result button { margin: 10px; background: green; color: white; }
    #redirect { margin-top: 30px; display: block; color: rgb(113,16,106); font-weight: bold; text-decoration: underline; }

    /* --------------------
       POPUP INICIAL
    -------------------- */
    #popup-video {
      display: block; /* fica vis√≠vel ao abrir p√°gina */
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #popup-video video {
      border-radius: 15px;
      max-width: 90%;
      max-height: 80%;
    }
    #popup-video button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      background-color: red;
      color: white;
      cursor: pointer;
    }

    /* --------------------
       RESPONSIVIDADE
    -------------------- */
    @media (max-width: 480px) {
      #logo { width: 280px; margin-bottom: 15px; }
      input { font-size: 14px; width: 95%; padding: 12px; box-sizing: border-box; }
      button { font-size: 14px; }
      #roleta-container { width: 250px; height: 250px; margin: 15px auto; }
      #seta-indicadora { font-size: 45px; right: -28px; }
      #spin { font-size: 18px; margin: 15px auto; padding: 12px 25px; }
      #result { font-size: 16px; margin-top: 15px; }
      #redirect { font-size: 14px; margin-top: 20px; }
    }
  </style>
</head>
<body>
  <!-- ====================
       FORMUL√ÅRIO OCULTO PARA GOOGLE SHEETS
       ==================== -->
  <iframe name="form-oculto" id="form-oculto" style="display:none;"></iframe>

  <!-- ====================
       POPUP INICIAL COM V√çDEO
       ==================== -->
  <div id="popup-video">
    <video id="video-inicial" width="500" controls autoplay loop preload="none" loading="lazy">
      <!-- üîπ Troque "video.mp4" pelo seu arquivo -->
      <source src="Celebracao.mp4" type="video/mp4">
      Seu navegador n√£o suporta v√≠deo.
    </video>
    <button onclick="fecharPopup()">Fechar V√≠deo e Continuar</button>
  </div>

  <!-- ====================
       LOGO E FORMUL√ÅRIO
       ==================== -->
  <img id="logo" src="logo box.png" alt="Box Motors Logo">

  <div id="form-container">
    <input type="text" id="nome" placeholder="Digite seu nome" aria-label="Nome completo" required>
    <input type="text" id="whatsapp" placeholder="WhatsApp com DDD" aria-label="N√∫mero de WhatsApp" required>
    <input type="text" id="cpf" placeholder="CPF (sem pontos ou tra√ßos)" maxlength="11" aria-label="CPF" required>
    <button id="validar-btn" onclick="validarCPF()" role="button" aria-label="Validar CPF">Validar CPF</button>
  </div>

  <!-- ====================
       ROLETA
       ==================== -->
  <div id="roleta-container">
    <div id="seta-indicadora">‚óÄ</div>
    <canvas id="wheel" width="300" height="300"></canvas>
  </div>

  <button id="spin" onclick="girarRoleta()" disabled role="button" aria-label="Girar roleta">üéÅ GIRAR A ROLETA üéÅ</button>
  <div id="result"></div>
  <a id="redirect" href="https://linktr.ee/BoxMotors" target="_blank">Clique aqui para acessar nosso link</a>

  <script>
    /* ====================
       LISTA DE PR√äMIOS E PROBABILIDADES
       ==================== */
    const premios = ["Troca de Oleo","Limpeza de freios","Brinde surpresa","Kit Transmiss√£o","Revis√£o","10% OFF"];
    const probabilidades = [5,10,30,1,0,20]; // mais alto = maior chance

    // CPFs usados persistentes
    let cpfsUsados = new Set(JSON.parse(localStorage.getItem("cpfsUsados") || "[]"));

    let angleCurrent = 0;
    let jogadorNome = '', jogadorWhatsapp = '', jogadorCpf = '';

    /* ====================
       FUN√á√ÉO DE VALIDA√á√ÉO REAL DE CPF
       ==================== */
    function validarCPFBrasileiro(cpf) {
        cpf = cpf.replace(/[^\d]+/g, ''); // Remove n√£o-d√≠gitos
        if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false; // Sequencial (111.111.111-11) inv√°lido

        let soma = 0, resto;
        for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.substring(9, 10))) return false;

        soma = 0;
        for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
        resto = (soma * 10) % 11;
        if (resto === 10 || resto === 11) resto = 0;
        if (resto !== parseInt(cpf.substring(10, 11))) return false;

        return true;
    }

    /* ====================
       DESENHAR ROLETA
       ==================== */
    function desenharRoleta(){
      const canvas = document.getElementById("wheel");
      const ctx = canvas.getContext("2d");
      const total = premios.length;
      const angle = 2*Math.PI/total;
      const colors = ["#950606","#000000"];
      for(let i=0;i<total;i++){
        ctx.beginPath();
        ctx.moveTo(150,150);
        ctx.arc(150,150,150,i*angle,(i+1)*angle);
        ctx.fillStyle = colors[i%2];
        ctx.fill();
        ctx.save();
        ctx.translate(150,150);
        ctx.rotate(i*angle + angle/2);
        ctx.textAlign="right";
        ctx.fillStyle="white";
        ctx.font="bold 14px arial";
        ctx.fillText(premios[i],130,8);
        ctx.restore();
      }
    }
    desenharRoleta();

    /* ====================
       ESCOLHER PR√äMIO PONDERADO
       ==================== */
    function escolherPremio(){
      const total = probabilidades.reduce((a,b)=>a+b,0);
      let rand = Math.random()*total;
      for(let i=0;i<premios.length;i++){
        if(rand<probabilidades[i]) return i;
        rand -= probabilidades[i];
      }
    }

    /* ====================
       VALIDAR CPF COM MELHORIAS
       ==================== */
    function validarCPF(){
      const cpf = document.getElementById("cpf").value.trim();
      const nome = document.getElementById("nome").value.trim();
      const whatsapp = document.getElementById("whatsapp").value.trim();
      if(cpf.length!==11 || nome==="" || whatsapp===""){
        alert("Preencha todos os dados corretamente.");
        return;
      }
      if (!validarCPFBrasileiro(cpf)) {
        alert("CPF inv√°lido! Verifique os d√≠gitos.");
        return;
      }
      if(cpfsUsados.has(cpf)){
        alert("Este CPF j√° foi utilizado nesta promo√ß√£o.");
        return;
      }
      const dataAtual = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
      const cpfsHoje = JSON.parse(localStorage.getItem(`cpfs_${dataAtual}`) || "[]");
      if (cpfsHoje.includes(cpf)) {
        alert("Este CPF j√° foi usado hoje!");
        return;
      }
      document.getElementById("spin").disabled=false;
      document.getElementById("validar-btn").disabled=true;
      alert("CPF validado! Voc√™ j√° pode girar a roleta.");
    }

    /* ====================
       SALVAR CPF COM LIMITE DI√ÅRIO
       ==================== */
    function salvarCPF(cpf){
      const dataAtual = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
      const cpfsHoje = JSON.parse(localStorage.getItem(`cpfs_${dataAtual}`) || "[]");
      if (cpfsHoje.includes(cpf)) {
        return false;
      }
      cpfsHoje.push(cpf);
      localStorage.setItem(`cpfs_${dataAtual}`, JSON.stringify(cpfsHoje));

      cpfsUsados.add(cpf);
      localStorage.setItem("cpfsUsados", JSON.stringify([...cpfsUsados]));
      return true;
    }

    /* ====================
       FECHAR POPUP INICIAL
       ==================== */
    function fecharPopup(){
      const popup = document.getElementById("popup-video");
      popup.style.display="none";

      // Opcional: iniciar som do v√≠deo
      const video = document.getElementById("video-inicial");
      video.muted = false;
      video.play();
    }

    /* ====================
       GIRAR ROLETA COM MELHORIAS
       ==================== */
    function girarRoleta(){
      jogadorNome = document.getElementById("nome").value.trim();
      jogadorWhatsapp = document.getElementById("whatsapp").value.trim();
      jogadorCpf = document.getElementById("cpf").value.trim();

      if (!salvarCPF(jogadorCpf)) {
        alert("Este CPF j√° girou a roleta hoje.");
        return;
      }

      document.getElementById('form-container').style.display='none';
      document.getElementById("spin").disabled=true;

      const rand = escolherPremio();
      const total = premios.length;
      const anglePerPrize = 360/total;
      const extraRotations = 6;
      const prizeMiddleAngle = (rand*anglePerPrize)+(anglePerPrize/2);
      const angleTo = (360*extraRotations)-prizeMiddleAngle;

      const canvas = document.getElementById("wheel");
      canvas.style.transition="transform 4s ease-out";
      canvas.style.transform = `rotate(${angleTo+angleCurrent}deg)`;
      angleCurrent += angleTo;

      setTimeout(()=>{
        const premio = premios[rand];
        document.getElementById("result").innerHTML = `üéâ Parab√©ns <strong>${jogadorNome}</strong>! Voc√™ ganhou: <strong>${premio}</strong> ü•≥ Para Validar Tire um print da tela e marque <strong>@box_motors</strong> no Instagram!`;

        // Confetti
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });
        
        // Som de vit√≥ria (se arquivo existir)
        const audioWin = new Audio('win.mp3');
        audioWin.play().catch(() => {}); // Ignora erros de autoplay

        // Bot√£o de compartilhar no WhatsApp
        const btnShare = document.createElement('button');
        btnShare.innerHTML = 'D√∫vidas no WhatsApp';
        btnShare.onclick = () => {
            const msg = `Ganhei ${premio} na roleta da Box Motors! @box_motors`;
            window.open(`https://wa.me/5569993144190?text=${encodeURIComponent(msg)}`);
        };
        document.getElementById("result").appendChild(btnShare);

        // Loading para Sheets
        const loading = document.createElement('p');
        loading.innerHTML = 'Enviando para valida√ß√£o...';
        loading.style.color = 'yellow';
        document.getElementById("result").appendChild(loading);
        
        // ‚úÖ Envia dados para Google Sheets
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = 'https://script.google.com/macros/s/AKfycbwo9cVXq7a0pZtoBiR-I8Tn5VgbMv-aATilPKOXedXVRoxeRCFi59ObSWGPc5sHHZse/exec';
        form.target = 'form-oculto';
        const dados = {nome:jogadorNome, whatsapp:jogadorWhatsapp, cpf:jogadorCpf, premio:premio};
        for(const key in dados){
          const input = document.createElement('input');
          input.type='hidden';
          input.name=key;
          input.value=dados[key];
          form.appendChild(input);
        }
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);

        // Remove loading ap√≥s envio
        setTimeout(() => {
          if (loading.parentNode) loading.remove();
        }, 2000);
      },4500);
    }

    /* ====================
       EVENT LISTENER PARA ENTER NO CPF
       ==================== */
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('cpf').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') validarCPF();
        });
    });
  </script>
</body>
</html>
